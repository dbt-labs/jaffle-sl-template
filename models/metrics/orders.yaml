semantic_models:
  - name: orders
    description: |
      Model containting order data. The grain of the table is the order id.
    model: ref('orders')
    defaults:
      agg_time_dimension: ds

    entities:
      - name: order_entity
        type: primary
        expr: order_id
      - name: location
        type: foreign
        expr: location_id
      - name: customer
        type: foreign
        expr: customer_id

    dimensions:
      - name: location_name
        type: categorical
      - name: ds
        expr: ordered_at
        type: time
        type_params:
          time_granularity: day
      - name: order_total_dim
        type: categorical
        expr: order_total
      - name: is_large_order
        type: categorical
        expr: case when order_total > 50 then true else false end
        # TODO: is this the right way to go about this?
      - name: customer_first_order
        type: categorical
        expr: |
          case when
            lag(order_id) over (partition by customer_id order by ordered_at) is not null
          end

    measures:
      - name: order_total
        agg: sum
        agg_time_dimension: ds
      - name: tax_paid
        agg: sum
        agg_time_dimension: ds
      - name: orders
        expr: "1"
        agg: sum
        agg_time_dimension: ds
      - name: max_order_value
        expr: order_total
        agg: max
        agg_time_dimension: ds
      - name: min_order_value
        expr: order_total
        agg: min
        agg_time_dimension: ds
      - name: average_order_value
        expr: order_total
        agg: average
        agg_time_dimension: ds
      - name: median_order_value
        expr: order_total
        agg: median
        agg_time_dimension: ds
      - name: customers
        expr: customer_id
        agg: count_distinct
        agg_time_dimension: ds
      - name: order_value_p99
        expr: order_total
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: False
          use_approximate_percentile: True
        agg_time_dimension: ds
      - name: discrete_order_value_p99
        expr: order_total
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: True
          use_approximate_percentile: False
        agg_time_dimension: ds
